---
title: "Ungulate nematode life history - Size"
author: "Dan Benesh"
output: html_document
---

In this document, I use the life cycle database to explore ideas about how and why helminths infect grazing mammals (ungulates).

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

I need several datasets to address these issues: (i) host associations for the parasites in the life cycle database,
(ii) life history variables for species in the life cycle database (body sizes and development), (iii) host body masses, and (iv) host taxonomy.

```{r importdata}
hosts <- read.csv(file = "../../data/CLC_database_hosts.csv", header = TRUE) 
lh <- read.csv(file = "../../data/CLC_database_lifehistory.csv", header = TRUE)
host_mass <- read.csv(file = "../../data/collated_host_mass_data.csv", header = TRUE)
host_tax <- read.csv(file = "../../data/ncbi_host_taxonomy.csv", header = TRUE)
```

Host taxonomies were downloaded from the NCBI database, and I used this taxonomic information to identify host species that are 'ungulates'. Specifically, I tagged species belonging to the orders Perissodactyla or Laurasiatheria. When we print out those hosts for quality control, it looks like this filter did a good job picking out what we commonly consider to be 'ungulates'

```{r}
# filter out ungulate host species
ungulate_host_species <- filter(host_tax, order == "Perissodactyla" | order == "Laurasiatheria")%>%
  select(sp.query, phylum, class, order, family, genus)
```

```{r}
# identify ungulates in list of hosts, add var
hosts <- mutate(hosts, 
                ungulate = if_else(Host.species %in% ungulate_host_species$sp.query, 1, 0))
# print common names
# filter(hosts, ungulate == 1)%>%select(Host.species, Host.common.name)%>%distinct()%>%
#   knitr::kable(format = 'html')
```

For each parasite species, I calculated the number of hosts in the life cycle. Some worms have facultative cycles where they can infect more or fewer hosts before reproducing, and here I assumed they took the longest route to the final host, i.e. through all facultative hosts, which may not be the most likely transmission route.

```{r}
# sp by lc data table
lcl <- group_by(hosts, Parasite.species, Parasite.group)%>%
  summarise(lcl = max(Host.no))
```

I also calculated worm biovolume based on their shape, such as whether they are cylindrical or ellipsoid. I further assumed a tissue density of 1.1. g/cm^3^ to convert these to biomasses, and then averaged these values for each life stage within a species. Adult size was calculated excluding males, as helminths can be dimorphic with males typically being smaller than females.

```{r}
# calc biomasses
lh <- mutate(lh, biovolume = 
                  if_else(Shape %in% c("cylinder", "thread-like", "whip"), 
                          pi * (Width/2)^2 * Length, # calculate volume as a cylinder
                          if_else(Shape %in% c("coiled", "sphere", "ellipsoid"),
                                  4/3 * pi * Length/2 * Width/4, # calculate volume as a ellipsoid
                                  Length * Width # calculate volume as area for remaining ribbon, leaf shapes
                                  )),
                biovolume = biovolume * 1.1) # covert to biomass with assumed 1.1. g/cm3 tissue density 

# species averages at adult stage
lh_biov_sp <-filter(lh, Stage == 'adult', (Sex == 'f' | is.na(Sex)) )%>% # remove adult males
  group_by(Parasite.species)%>%
  summarize(adult_biov = mean(biovolume, na.rm=T),
            adult_dt = mean(Development.time, na.rm = T))
```

```{r}
# calc mean host sizes
host_mass_avg <- group_by(host_mass, binomial)%>%
  summarize(body.mass = mean(body.mass, na.rm=T))
# add to hosts db
hosts <- left_join(hosts, host_mass_avg, by = c("Host.species" = "binomial"))
```

I then filtered the dataset to just nematodes infecting ungulates. For parasite species infecting multiple ungulate host species, I averaged body masses across host species.

```{r}
# filter to ungulate-infecting helminths, excluding those accidentally or atypically found in ungulates
ung_parasites <- filter(hosts, ungulate == 1, Typical.host == 'typical', Parasite.group == "nematode")%>%
  group_by(Parasite.species, Host.no, Def.int)%>%
  summarize(host.bm = mean(body.mass, na.rm = T))
```

```{r}
# combine parasite sizes, host sizes, life cycle info for plotting
ung_parasites <- left_join(ung_parasites, lcl)
ung_parasites <- left_join(ung_parasites, lh_biov_sp)
ung_parasites <- mutate(ung_parasites, complex = if_else(lcl == 1, "direct", "complex"))

# add hatching strategy to plot data
hatch <- select(lh, Parasite.species, hatch = Egg.hatch)%>%
  mutate(hatch = if_else(hatch == 'eaten', 'egg eaten', 'hatched larva'))%>% # simplify hatch strategy
           na.omit()%>%distinct()
ung_parasites <- left_join(ung_parasites, hatch)

# make var combining hatching and life cycle strategies
ung_parasites <- mutate(ung_parasites, trans_strat = if_else(complex == "complex", "int host", hatch))
```

```{r}
with(ung_parasites, table(complex, hatch))
```


Read in tree and then make sure the tip labels match the names in the data frame

```{r}
tree <- read.nexus(file = "tree_for_ung_nematodes.nex")
match_df <- read.csv(file = "tree_for_ung_name_matching.csv")

mv <- match(tree$tip.label, match_df$tree_name)
tree$tip.label <- match_df$data_name[mv]
```


Plot things on tree to get an idea of phy sig, etc.
```{r}
library(ggtree)
```

```{r}
# exclude missing values
red_dat_size <- filter(ung_parasites, !is.nan(adult_biov), !is.na(adult_biov))
# reduce tree to just remaining spp
tree_x <- keep.tip(tree, red_dat_size$Parasite.species)
```
```{r}
tree_df <- fortify(tree_x)
tree_df <- left_join(tree_df, red_dat_size, by = c("label" = "Parasite.species"))
```

```{r}
p <- ggtree(tree_df)
facet_plot(p, panel = 'Adult worm size', 
           data = select(ungroup(red_dat_size), id = Parasite.species, val = adult_biov),
           geom = geom_segment, aes(x=min(log10(adult_biov)), xend = log10(adult_biov), y = y, yend = y))
```
```{r}
facet_plot(p, panel = 'Host Mass', 
           data = select(ungroup(red_dat_size), id = Parasite.species, val = host.bm),
           geom = geom_segment, aes(x=min(log10(host.bm)), xend = log10(host.bm), y = y, yend = y))
```

```{r}
ggtree(tree_df) +
  geom_tiplab(aes(color = hatch), size = 2) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme(legend.position = c(0.3, 1),
        legend.justification = c(1,1),
        legend.title = element_blank(),
        legend.text = element_text(size = 5))
```
```{r}
ggtree(tree_df) +
  geom_tiplab(aes(color = factor(lcl)), size = 2) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme(legend.position = c(0.3, 1),
        legend.justification = c(1,1),
        legend.title = element_blank(),
        legend.text = element_text(size = 5))
```


Make models

```{r}
library(MASS)
library(nlme)
```

Just role of phylogeny, no predictors.

```{r}
# exclude missing values
red_dat_size <- filter(ung_parasites, !is.nan(adult_biov), !is.na(adult_biov))
# reduce tree to just remaining spp
tree_x <- keep.tip(tree, red_dat_size$Parasite.species)

# fit gls reg with and without phylogeny - no predictors
reg1 <- gls(log10(adult_biov) ~ 1, 
            data = red_dat_size,
            method="ML")
reg2 <- gls(log10(adult_biov) ~ 1, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
summary(reg2)
```

The lambda parameter was moderate 0.4, suggesting some phylogenetic signal in nematode body sizes. It was enough to cause a significant difference from the intercept-only model.

```{r}
anova(reg1, reg2)
```

Host size matters

```{r}
# exclude missing values
red_dat_size <- filter(ung_parasites, !is.nan(adult_biov), !is.na(adult_biov),
                       !is.nan(host.bm), !is.na(host.bm))
# reduce tree to just remaining spp
tree_x <- keep.tip(tree, red_dat_size$Parasite.species)

# fit gls reg with phylogeny, with and without host size
reg1 <- gls(log10(adult_biov) ~ 1, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg2 <- gls(log10(adult_biov) ~ log10(host.bm), 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
summary(reg2)
anova(reg1, reg2)
```

```{r}
ggplot(red_dat_size, aes(x = log10(host.bm), y = log10(adult_biov))) +
  geom_point(alpha = 0.5) + 
  geom_abline(intercept = reg2$coefficients[1], slope = reg2$coefficients[2]) +
  labs(x = "Log Host Body Mass", y = "Log Worm Mass")
```

```{r}
# exclude missing values
red_dat_size <- filter(ung_parasites, !is.nan(adult_biov), !is.na(adult_biov),
                       !is.nan(host.bm), !is.na(host.bm), !is.na(complex), !is.na(hatch))
# reduce tree to just remaining spp
tree_x <- keep.tip(tree, red_dat_size$Parasite.species)

# fit gls reg
reg1 <- gls(log10(adult_biov) ~ 1, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg2 <- gls(log10(adult_biov) ~ log10(host.bm), 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg3.1 <- gls(log10(adult_biov) ~ log10(host.bm) + complex, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg3.2 <- gls(log10(adult_biov) ~ log10(host.bm) + hatch, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
anova(reg2, reg3.1) # no effect of int host
anova(reg2, reg3.2) # effect of hatching
```

```{r}
ggplot(red_dat_size, aes(x = log10(host.bm), y = log10(adult_biov), color = hatch)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(se = F, method = 'lm') +
  # geom_abline(intercept = reg2$coefficients[1], slope = reg2$coefficients[2]) +
  labs(x = "Log Host Body Mass", y = "Log Worm Mass")
```
```{r}
ggplot(red_dat_size, aes(x = log10(host.bm), y = log10(adult_biov), color = complex)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(se = F, method = 'lm') +
  # geom_abline(intercept = reg2$coefficients[1], slope = reg2$coefficients[2]) +
  labs(x = "Log Host Body Mass", y = "Log Worm Mass")
```


```{r}
reg4 <- gls(log10(adult_biov) ~ log10(host.bm) + complex*hatch, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
anova(reg4) # hatchers
```

Which one was up top?

```{r}
filter(red_dat_size, log10(adult_biov) > 3)
```

Results still hold after excluding?

```{r}
# exclude missing values
red_dat_size <- filter(ung_parasites, !is.nan(adult_biov), !is.na(adult_biov),
                       !is.nan(host.bm), !is.na(host.bm), !is.na(complex), !is.na(hatch),
                       Parasite.species != "Toxocara vitulorum")
# reduce tree to just remaining spp
tree_x <- keep.tip(tree, red_dat_size$Parasite.species)

# fit gls reg
reg1 <- gls(log10(adult_biov) ~ 1, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg2 <- gls(log10(adult_biov) ~ log10(host.bm), 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg3.1 <- gls(log10(adult_biov) ~ log10(host.bm) + complex, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg3.2 <- gls(log10(adult_biov) ~ log10(host.bm) + hatch, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
anova(reg2, reg3.1) # no effect of int host
anova(reg2, reg3.2) # effect of hatching
```

Try with trans strat

```{r}
# exclude missing values
red_dat_size <- filter(ung_parasites, !is.nan(adult_biov), !is.na(adult_biov),
                       !is.nan(host.bm), !is.na(host.bm), !is.na(trans_strat))
# reduce tree to just remaining spp
tree_x <- keep.tip(tree, red_dat_size$Parasite.species)

# fit gls reg
reg1 <- gls(log10(adult_biov) ~ 1, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg2 <- gls(log10(adult_biov) ~ log10(host.bm), 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
reg3.1 <- gls(log10(adult_biov) ~ log10(host.bm) + trans_strat, 
            data = red_dat_size,
            method="ML",
            correlation=corPagel(value=1, phy=tree_x, fixed=FALSE))
summary(reg3.1)
anova(reg2, reg3.1) # effect of trans stategy
```

```{r}
ggplot(red_dat_size, aes(x = log10(host.bm), y = log10(adult_biov), color = trans_strat)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(se = F, method = 'lm') +
  labs(x = "Log Host Body Mass", y = "Log Worm Mass")
```

# Conclusions

In nematodes of ungulates, adult worm size increases with host size. There is phylogenetic signal in adult size. There is phylogenetic signal in life cycles (hatching strategy and intermediate host use). Nonetheless, directly-transmitted hatched worms are slightly smaller.
